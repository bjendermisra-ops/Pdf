<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax-Aware Retirement Corpus Planner (INR)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .calculator-container { background-color: white; border: 1px solid #e2e8f0; }
        .input-card { background-color: #f9fafb; border: 1px solid #e5e7eb; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center">

   <!-- Back Button -->
<div class="fixed top-6 left-6 z-50">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <a href="/"
     class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white
            rounded-full shadow-md w-fit
            bg-gradient-to-r from-blue-600 to-blue-700
            hover:from-blue-700 hover:to-indigo-800
            hover:-translate-x-1 hover:shadow-lg
            transition-all duration-300 ease-in-out">
    <i class="fas fa-arrow-left text-sm"></i>
    <span>Back to All Tools</span>
  </a>
</div>


    <div class="w-full max-w-7xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-2 text-center">
            Tax-Aware Retirement Corpus Planner
        </h1>
        <p class="text-center text-gray-600 mb-8">Project your portfolio runway with tax-adjusted and inflation-indexed withdrawals</p>

        <div class="p-4 md:p-8 rounded-xl shadow-2xl calculator-container space-y-8">
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Input Panel -->
                <div class="lg:col-span-1 space-y-4 p-5 rounded-lg input-card shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Financial Inputs</h2>

                    <!-- Initial Corpus (Balance) -->
                    <div>
                        <label for="initial-balance" class="block text-sm font-medium text-gray-700 flex items-center mb-1">
                            <i data-lucide="wallet" class="w-4 h-4 mr-2 text-indigo-500"></i> Initial Portfolio Corpus
                        </label>
                        <input type="number" id="initial-balance" value="20000000" min="0" step="100000"
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-lg"
                               oninput="calculateProjection()">
                    </div>

                    <!-- Gross Annual Withdrawal -->
                    <div>
                        <label for="annual-withdrawal" class="block text-sm font-medium text-gray-700 flex items-center mb-1">
                            <i data-lucide="minus-circle" class="w-4 h-4 mr-2 text-red-500"></i> Target Gross Annual Withdrawal 
                        </label>
                        <input type="number" id="annual-withdrawal" value="800000" min="0" step="10000"
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-lg"
                               oninput="calculateProjection()">
                    </div>

                    <!-- Expected Return -->
                    <div>
                        <label for="expected-return" class="block text-sm font-medium text-gray-700 flex items-center mb-1">
                            <i data-lucide="trending-up" class="w-4 h-4 mr-2 text-green-500"></i> Expected Annual Return (%)
                        </label>
                        <input type="number" id="expected-return" value="7.0" min="0" max="20" step="0.1"
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-lg"
                               oninput="calculateProjection()">
                    </div>

                    <!-- Inflation Rate -->
                    <div>
                        <label for="inflation-rate" class="block text-sm font-medium text-gray-700 flex items-center mb-1">
                            <i data-lucide="baseline" class="w-4 h-4 mr-2 text-amber-500"></i> Annual Inflation Rate (%)
                        </label>
                        <input type="number" id="inflation-rate" value="5.0" min="0" max="10" step="0.1"
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-lg"
                               oninput="calculateProjection()">
                    </div>

                    <!-- Tax Inputs (Unique Feature) -->
                    <h3 class="text-md font-bold text-gray-600 pt-2 border-t mt-4">Tax & Withdrawal Mix</h3>

                    <!-- Taxable Withdrawal Percentage -->
                    <div>
                        <label for="taxable-withdrawal-pct" class="block text-sm font-medium text-gray-700 flex items-center mb-1">
                            <i data-lucide="shield-half" class="w-4 h-4 mr-2 text-blue-500"></i> Taxable Portion of Withdrawal (%)
                        </label>
                        <input type="number" id="taxable-withdrawal-pct" value="70" min="0" max="100" step="1"
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-lg"
                               oninput="calculateProjection()">
                        <p class="text-xs text-gray-500 mt-1">e.g., if 70% of funds are from taxable sources (MFs, FDs).</p>
                    </div>

                    <!-- Income Tax Rate -->
                    <div>
                        <label for="income-tax-rate" class="block text-sm font-medium text-gray-700 flex items-center mb-1">
                            <i data-lucide="percent" class="w-4 h-4 mr-2 text-blue-500"></i> Effective Income Tax Rate (%)
                        </label>
                        <input type="number" id="income-tax-rate" value="10" min="0" max="50" step="1"
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-lg"
                               oninput="calculateProjection()">
                        <p class="text-xs text-gray-500 mt-1">Flat rate applied to the Taxable Portion.</p>
                    </div>

                    <!-- Age Range -->
                    <h3 class="text-md font-bold text-gray-600 pt-2 border-t mt-4">Retirement Duration</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="current-age" class="block text-sm font-medium text-gray-700 flex items-center mb-1">
                                Start Age
                            </label>
                            <input type="number" id="current-age" value="60" min="20" max="100"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-lg"
                                   oninput="calculateProjection()">
                        </div>
                        <div>
                            <label for="lifespan-age" class="block text-sm font-medium text-gray-700 flex items-center mb-1">
                                End Age
                            </label>
                            <input type="number" id="lifespan-age" value="90" min="70" max="120"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-lg"
                                   oninput="calculateProjection()">
                        </div>
                    </div>
                </div>

                <!-- Output Panel (Summary & Graph Removed) -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <!-- Summary Card (Required Corpus Estimation - Unique Feature) -->
                    <div class="p-6 bg-purple-50 rounded-lg shadow-xl border border-purple-200">
                        <h2 class="text-xl font-bold text-purple-700 mb-3 flex items-center">
                            <i data-lucide="check-circle-2" class="w-6 h-6 mr-2"></i> Corpus Sufficiency Analysis
                        </h2>
                        <p id="runway-summary" class="text-xl font-extrabold text-purple-800">Calculating...</p>
                        <p id="required-corpus" class="text-base text-gray-600 mt-2 font-medium">Required Initial Corpus: N/A</p>
                    </div>
                    
                    <!-- Projected Take-Home Withdrawal -->
                    <div class="p-6 bg-green-50 rounded-lg shadow-xl border border-green-200">
                        <h2 class="text-xl font-bold text-green-700 mb-3 flex items-center">
                            <i data-lucide="wallet-2" class="w-6 h-6 mr-2"></i> Initial Net Take-Home Withdrawal
                        </h2>
                        <p id="net-withdrawal-summary" class="text-2xl font-extrabold text-green-800">Calculating...</p>
                        <p class="text-sm text-gray-600 mt-2">This is the net withdrawal after applying the effective income tax rate to the taxable portion.</p>
                    </div>

                    <!-- Placeholder for where the chart was -->
                    <div class="bg-gray-200 p-8 rounded-lg border border-gray-300 shadow-inner text-center">
                        <p class="text-gray-600 font-semibold text-lg">Detailed Projection Table Below.</p>
                        <p class="text-sm text-gray-500">The portfolio projection graph was removed to focus on detailed tax and corpus requirements.</p>
                    </div>
                </div>
            </div>

            <!-- Detail Table -->
            <div class="mt-8">
                <h2 class="text-2xl font-bold text-gray-700 border-b pb-2 mb-4">Yearly Projection Details (Net Withdrawal)</h2>
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year (Age)</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Start Corpus (₹)</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Gross Withdrawal (₹)</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Net Take-Home (₹)</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Corpus Growth (₹)</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">End Corpus (₹)</th>
                            </tr>
                        </thead>
                        <tbody id="projection-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Rows populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Utility function to format numbers as Indian Rupees
        const formatter = new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
        
        // Detailed formatter for showing exact amounts
        const detailFormatter = new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        
        // --- Core Calculation Logic ---

        /**
         * Calculates the year-by-year portfolio projection, including tax deductions.
         */
        function calculateProjection() {
            // 1. Get Inputs
            const initialBalance = parseFloat(document.getElementById('initial-balance').value) || 0;
            const initialGrossWithdrawal = parseFloat(document.getElementById('annual-withdrawal').value) || 0;
            const expectedReturn = parseFloat(document.getElementById('expected-return').value) / 100 || 0;
            const inflationRate = parseFloat(document.getElementById('inflation-rate').value) / 100 || 0;
            const taxablePct = parseFloat(document.getElementById('taxable-withdrawal-pct').value) / 100 || 0;
            const taxRate = parseFloat(document.getElementById('income-tax-rate').value) / 100 || 0;
            const startAge = parseInt(document.getElementById('current-age').value) || 60;
            const endAge = parseInt(document.getElementById('lifespan-age').value) || 90;

            // Input validation and setup
            if (initialBalance <= 0 || initialGrossWithdrawal <= 0 || startAge >= endAge) {
                updateSummary(null, null, null);
                updateTable([]);
                return;
            }

            let balance = initialBalance;
            let currentGrossWithdrawal = initialGrossWithdrawal;
            let year = 1;
            let results = [];
            let fundDuration = null;

            // Calculate initial net withdrawal
            const initialNetWithdrawal = calculateNetWithdrawal(currentGrossWithdrawal, taxablePct, taxRate);
            document.getElementById('net-withdrawal-summary').textContent = detailFormatter.format(initialNetWithdrawal);


            // --- Core Forward Projection ---
            for (let age = startAge; age <= endAge; age++) {
                
                const startBalance = balance;
                let corpusGrowth = 0;
                let endBalance = 0;
                let actualGrossWithdrawal = 0;
                let netWithdrawal = 0;
                let portfolioValueBeforeWithdrawal;

                if (balance > 0) {
                    
                    // 1. Inflation adjustment (for gross withdrawal target)
                    if (year > 1) {
                        currentGrossWithdrawal = currentGrossWithdrawal * (1 + inflationRate);
                    }
                    actualGrossWithdrawal = currentGrossWithdrawal;

                    // 2. Calculate portfolio growth (before withdrawal)
                    portfolioValueBeforeWithdrawal = startBalance * (1 + expectedReturn);
                    corpusGrowth = portfolioValueBeforeWithdrawal - startBalance;

                    // 3. Determine end balance 
                    endBalance = portfolioValueBeforeWithdrawal - actualGrossWithdrawal;
                    
                    // Calculate net take-home (for display in the table)
                    netWithdrawal = calculateNetWithdrawal(actualGrossWithdrawal, taxablePct, taxRate);

                    // 4. Handle run-out scenario (withdrawal exceeds remaining balance)
                    if (endBalance < 0) {
                        // The withdrawal requested is greater than the remaining portfolio value
                        
                        // The actual gross withdrawal is limited to the remaining portfolio
                        actualGrossWithdrawal = portfolioValueBeforeWithdrawal;
                        endBalance = 0;
                        
                        // Recalculate net withdrawal based on the limited actual withdrawal amount
                        netWithdrawal = calculateNetWithdrawal(actualGrossWithdrawal, taxablePct, taxRate);
                        
                        if (fundDuration === null) {
                            fundDuration = age;
                        }
                    }
                } else {
                    // Portfolio is already exhausted
                    balance = 0;
                    actualGrossWithdrawal = 0;
                    corpusGrowth = 0;
                    endBalance = 0;
                    netWithdrawal = 0;
                    if (fundDuration === null) {
                        fundDuration = age;
                    }
                }

                results.push({
                    year: year,
                    age: age,
                    startBalance: startBalance,
                    grossWithdrawal: actualGrossWithdrawal,
                    netWithdrawal: netWithdrawal,
                    corpusGrowth: corpusGrowth,
                    endBalance: endBalance
                });

                balance = endBalance;
                year++;
            }

            // --- Required Corpus Calculation (Unique Feature) ---
            const requiredCorpus = calculateRequiredCorpus(results, initialGrossWithdrawal, expectedReturn, inflationRate, startAge, endAge);


            updateSummary(fundDuration, startAge, endAge, initialBalance, requiredCorpus);
            updateTable(results);
        }

        /**
         * Calculates the Net Take-Home Withdrawal after applying tax.
         */
        function calculateNetWithdrawal(grossWithdrawal, taxablePct, taxRate) {
            // Taxable amount = Gross Withdrawal * Taxable Percentage (e.g., 70% of withdrawal is taxable)
            const taxableAmount = grossWithdrawal * taxablePct;
            
            // Tax paid = Taxable Amount * Tax Rate (e.g., 70% * 10% tax rate)
            const taxPaid = taxableAmount * taxRate;
            
            // Net Withdrawal = Gross Withdrawal - Tax Paid
            return grossWithdrawal - taxPaid;
        }

        /**
         * Estimates the required initial corpus needed to sustain all withdrawals.
         * Note: This is a simplified estimation by iterating the required balance backwards, 
         * which is sufficient for summary-level display.
         */
        function calculateRequiredCorpus(results, initialGrossWithdrawal, expectedReturn, inflationRate, startAge, endAge) {
            let requiredCorpus = 0;
            const years = endAge - startAge;

            if (years <= 0 || results.length === 0) return 0;

            // Iterate backwards from the last year of the projection
            for (let i = results.length - 1; i >= 0; i--) {
                const r = results[i];
                const age = r.age;
                const yearIndex = age - startAge;

                // 1. Calculate the gross withdrawal needed for THIS year, adjusted for inflation
                // This simulates the actual withdrawal amount needed regardless of the current balance
                let withdrawalNeeded = initialGrossWithdrawal * Math.pow(1 + inflationRate, yearIndex);

                // 2. The required balance at the START of this year must cover the withdrawal and grow to cover the next year's needs.
                // Since we are not modeling a final balance (legacy = 0), the end corpus needed at age 90 is 0.
                
                let futureValueNeeded = (i === results.length - 1) ? 0 : requiredCorpus;
                
                // Required Balance at Start of Year (Corpus) = (Future Value Needed + Withdrawal Needed) / (1 + Expected Return)
                requiredCorpus = (futureValueNeeded + withdrawalNeeded) / (1 + expectedReturn);
            }

            return requiredCorpus;
        }


        // --- UI Updates ---

        /**
         * Updates the summary card with the duration and required corpus results.
         */
        function updateSummary(fundDuration, startAge, endAge, initialBalance, requiredCorpus) {
            const summaryElement = document.getElementById('runway-summary');
            const requiredCorpusElement = document.getElementById('required-corpus');
            
            if (requiredCorpus === null) {
                summaryElement.textContent = "Please enter valid initial savings and withdrawal amounts to begin calculation.";
                requiredCorpusElement.textContent = "Required Initial Corpus: N/A";
                return;
            }

            requiredCorpusElement.textContent = `Required Initial Corpus: ${formatter.format(requiredCorpus)}`;

            if (fundDuration === null) {
                // Funds lasted the entire projection
                const remaining = initialBalance - requiredCorpus;
                summaryElement.innerHTML = `Success! Your **Initial Corpus** is sufficient for your entire lifespan (age ${endAge}). You have a surplus of ${formatter.format(remaining)}.`;
                summaryElement.classList.remove('text-red-600', 'text-yellow-600');
                summaryElement.classList.add('text-green-800');
            } else if (fundDuration <= endAge) {
                // Funds ran out early
                const years = fundDuration - startAge;
                const yearsShort = endAge - fundDuration;
                const deficit = requiredCorpus - initialBalance;
                
                summaryElement.innerHTML = `Warning: Corpus runs out at age **${fundDuration}** (after ${years} years). You need an additional **${formatter.format(deficit)}** to reach age ${endAge}.`;
                summaryElement.classList.remove('text-green-800');
                summaryElement.classList.add('text-red-600');
                
                if (yearsShort < 5) { // Mild warning for shortfalls
                    summaryElement.classList.add('text-yellow-600');
                }
            }
        }

        /**
         * Populates the detail table with projection data.
         */
        function updateTable(results) {
            const tableBody = document.getElementById('projection-table-body');
            tableBody.innerHTML = '';

            results.forEach(r => {
                const row = document.createElement('tr');
                let rowClasses = 'whitespace-nowrap';
                
                // Highlight when funds run out
                if (r.startBalance === 0 && r.endBalance === 0 && r.age > results[0].age) {
                    rowClasses += ' bg-red-100 text-red-600 font-bold';
                } else if (r.endBalance < r.startBalance && r.endBalance > 0 && r.startBalance > 0) {
                    // Highlight years where balance shrinks
                    rowClasses += ' bg-yellow-50';
                }

                row.className = rowClasses;

                row.innerHTML = `
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">${r.year} (${r.age})</td>
                    <td class="px-4 py-2 text-sm text-gray-700 text-right">${detailFormatter.format(r.startBalance)}</td>
                    <td class="px-4 py-2 text-sm text-gray-700 text-right">${detailFormatter.format(r.grossWithdrawal)}</td>
                    <td class="px-4 py-2 text-sm font-semibold text-green-700 text-right">${detailFormatter.format(r.netWithdrawal)}</td>
                    <td class="px-4 py-2 text-sm text-gray-700 text-right">${detailFormatter.format(r.corpusGrowth)}</td>
                    <td class="px-4 py-2 text-sm font-semibold text-gray-900 text-right">${detailFormatter.format(r.endBalance)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- Initialization ---
        window.onload = calculateProjection; // Run initial calculation on load
    </script>
</body>
</html>