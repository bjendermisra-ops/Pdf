<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF to CSV Converter</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- PDF.js CDN for preview and text extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js"></script>
    <!-- SheetJS for CSV generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.0/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: #fff;
        min-height: 100vh;
        overflow-x: hidden;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1.5rem;
      }
      .drop-zone {
        border: 3px dashed #93c5fd;
        border-radius: 16px;
        padding: 2.5rem;
        text-align: center;
        background: #eef2ff;
        transition: all 0.3s ease;
      }
      .drop-zone.dragover {
        border-color: #2563eb;
        background: #dbeafe;
        transform: scale(1.02);
      }
      .preview-box {
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-top: 1.5rem;
        display: none;
      }
      #pdfPreview {
        width: 100%;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        overflow: hidden;
        margin-top: 1rem;
      }
      .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      .preview-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
      }
      .preview-close {
        cursor: pointer;
        color: #6b7280;
        transition: color 0.2s;
      }
      .preview-close:hover {
        color: #ef4444;
      }
      .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        justify-content: center;
      }
      @media (max-width: 640px) {
        .container {
          padding: 1rem;
        }
        .drop-zone {
          padding: 1.5rem;
        }
        .action-buttons {
          flex-direction: column;
        }
        button {
          width: 100%;
        }
      }
      .loading-spinner {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1
        class="text-5xl font-extrabold text-center text-black mt-5 mb-4 sm:text-3xl"
      >
        PDF to CSV Converter
      </h1>
      <p class="text-xl text-center text-gray-500 mb-10 sm:text-xl">
        This PDF to CSV Converter extracts structured tabular data from PDF
        files<br />
        and converts it into a clean, editable CSV file
      </p>

      <!-- Drop Zone -->
      <div
        class="drop-zone max-w-3xl mx-auto"
        id="dropZone"
        style="min-height: 300px"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-12 w-12 mx-auto text-indigo-500"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
          />
        </svg>
        <p class="text-gray-700 text-xl font-medium sm:text-base mt-3">
          Drop your PDF here
        </p>
        <input type="file" id="pdfInput" accept=".pdf" class="hidden" />
        <button
          id="selectFileBtn"
          class="mt-4 px-6 py-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition text-base sm:text-sm shadow-md"
        >
          Select File
        </button>
        <p class="text-gray-500 text-sm mt-3">Supports PDF files with tables</p>
      </div>

      <!-- Preview Box -->
      <div class="preview-box max-w-3xl mx-auto" id="previewBox">
        <div class="preview-header">
          <h3 class="preview-title">PDF Preview</h3>
          <span class="preview-close" id="closePreview">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </span>
        </div>
        <div id="pdfPreview"></div>

        <div class="action-buttons">
          <button
            id="convertBtn"
            class="px-6 py-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition text-base sm:text-sm shadow-md flex items-center justify-center gap-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
            Convert to CSV
          </button>
        </div>

        <p
          id="status"
          class="text-gray-600 mt-4 text-sm text-center hidden"
        ></p>
      </div>
    </div>

    <script>
      // Initialize PDF.js worker
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js";

      $(document).ready(function () {
        const $dropZone = $("#dropZone");
        const $input = $("#pdfInput");
        const $previewBox = $("#previewBox");
        const $pdfPreview = $("#pdfPreview");
        const $status = $("#status");
        const $selectFileBtn = $("#selectFileBtn");
        const $convertBtn = $("#convertBtn");
        const $closePreview = $("#closePreview");

        let currentPDFFile = null;

        // Setup drag and drop
        $dropZone.on({
          dragover: function (e) {
            e.preventDefault();
            $(this).addClass("dragover");
          },
          dragleave: function () {
            $(this).removeClass("dragover");
          },
          drop: function (e) {
            e.preventDefault();
            $(this).removeClass("dragover");
            if (e.originalEvent.dataTransfer.files.length) {
              handleFile(e.originalEvent.dataTransfer.files[0]);
            }
          },
        });

        $selectFileBtn.on("click", () => $input.click());
        $input.on("change", function () {
          if (this.files.length) {
            handleFile(this.files[0]);
          }
        });

        $closePreview.on("click", function () {
          $previewBox.slideUp(300);
          $dropZone.slideDown(300);
          currentPDFFile = null;
          $input.val(""); // Clear file input
        });

        function handleFile(file) {
          // Check if file is PDF
          if (
            !file.type.match("application/pdf") &&
            !file.name.toLowerCase().endsWith(".pdf")
          ) {
            showStatus("Please select a valid PDF file", "error");
            return;
          }

          currentPDFFile = file;
          $dropZone.slideUp(300);
          $previewBox.removeClass("hidden").slideDown(300);
          showPDFPreview(file);
        }

        function showPDFPreview(file) {
          $pdfPreview.html(
            '<p class="text-center py-10 text-gray-500">Loading PDF preview...</p>'
          );

          const fileReader = new FileReader();

          fileReader.onload = function () {
            const typedArray = new Uint8Array(this.result);

            // Load the PDF document
            pdfjsLib
              .getDocument(typedArray)
              .promise.then(function (pdf) {
                // Fetch the first page for preview
                pdf.getPage(1).then(function (page) {
                  const viewport = page.getViewport({ scale: 1.5 });

                  // Prepare canvas
                  const canvas = document.createElement("canvas");
                  const context = canvas.getContext("2d");
                  canvas.height = viewport.height;
                  canvas.width = viewport.width;

                  // Clear previous content
                  $pdfPreview.empty().append(canvas);

                  // Render PDF page into canvas context
                  const renderContext = {
                    canvasContext: context,
                    viewport: viewport,
                  };

                  page.render(renderContext);
                });
              })
              .catch(function (error) {
                $pdfPreview.html(
                  '<p class="text-red-500 text-center py-10">Error loading PDF: ' +
                    error.message +
                    "</p>"
                );
                showStatus("Failed to load PDF", "error");
              });
          };

          fileReader.readAsArrayBuffer(file);
        }

        $convertBtn.on("click", async function () {
          if (!currentPDFFile) {
            showStatus("Please select a PDF file first", "error");
            return;
          }

          // Start conversion
          $(this).prop("disabled", true);
          $(this).html('<span class="loading-spinner"></span> Converting...');
          $status
            .removeClass("hidden")
            .text("Extracting data from PDF...")
            .addClass("text-blue-600")
            .removeClass("text-red-600 text-green-600");

          try {
            const fileReader = new FileReader();
            fileReader.onload = async function () {
              const typedArray = new Uint8Array(this.result);
              const pdf = await pdfjsLib.getDocument(typedArray).promise;
              let csvData = [];
              let headers = null;

              // Process each page
              for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();

                // Extract text items and group by lines
                let lines = [];
                let currentLine = [];
                let lastY = null;

                textContent.items.forEach((item) => {
                  const y = item.transform[5]; // Y-coordinate
                  const text = item.str.trim();

                  if (text) {
                    if (lastY === null || Math.abs(y - lastY) < 5) {
                      // Same line
                      currentLine.push(text);
                    } else {
                      // New line
                      if (currentLine.length) {
                        lines.push(currentLine.join(" "));
                      }
                      currentLine = [text];
                    }
                    lastY = y;
                  }
                });

                // Push the last line
                if (currentLine.length) {
                  lines.push(currentLine.join(" "));
                }

                // Attempt to parse lines as table data
                lines.forEach((line) => {
                  // Split by commas, tabs, or multiple spaces
                  const cells = line
                    .split(/,|\t| {2,}/)
                    .map((cell) => cell.trim())
                    .filter((cell) => cell);

                  if (cells.length > 1) {
                    // Assume it's a table row if multiple cells
                    if (!headers) {
                      // First row with multiple cells is assumed to be headers
                      headers = cells;
                      csvData.push(headers);
                    } else {
                      // Ensure row has same number of columns as headers
                      if (cells.length === headers.length) {
                        csvData.push(cells);
                      }
                    }
                  }
                });
              }

              if (csvData.length === 0) {
                throw new Error("No table data detected in the PDF.");
              }

              // Convert to CSV using SheetJS
              const ws = XLSX.utils.aoa_to_sheet(csvData);
              const csvContent = XLSX.write(ws, {
                type: "string",
                bookType: "csv",
              });

              // Trigger download
              const blob = new Blob([csvContent], { type: "text/csv" });
              const url = URL.createObjectURL(blob);
              const link = document.createElement("a");
              link.href = url;
              link.download =
                currentPDFFile.name.replace(".pdf", ".csv") || "converted.csv";
              document.body.appendChild(link);
              link.click();
              setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
              }, 100);

              $convertBtn.prop("disabled", false);
              $convertBtn.html(`
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Convert to CSV
                        `);
              $status
                .text("Conversion complete! CSV downloaded.")
                .removeClass("text-blue-600")
                .addClass("text-green-600");
            };

            fileReader.readAsArrayBuffer(currentPDFFile);
          } catch (error) {
            console.error("Conversion error:", error);
            $convertBtn.prop("disabled", false);
            $convertBtn.html(`
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Convert to CSV
                    `);
            $status
              .text(error.message || "Failed to convert PDF to CSV.")
              .removeClass("text-blue-600")
              .addClass("text-red-600");
          }
        });

        function showStatus(message, type = "info") {
          $status
            .removeClass("hidden")
            .text(message)
            .removeClass("text-blue-600 text-green-600 text-red-600")
            .addClass(
              type === "error"
                ? "text-red-600"
                : type === "success"
                ? "text-green-600"
                : "text-blue-600"
            );

          if (type !== "info") {
            setTimeout(() => {
              $status.addClass("hidden");
            }, 5000);
          }
        }
      });
    </script>
  </body>
</html>
