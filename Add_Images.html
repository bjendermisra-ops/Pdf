<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Image Overlay Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    #canvas-container {
      position: relative;
      display: inline-block;
    }

    #base-image {
      max-width: 100%;
      display: block;
    }

    .overlay-image {
      position: absolute;
      cursor: move;
      max-width: 300px;
      max-height: 300px;
    }

    .overlay-controls {
      position: absolute;
      top: -25px;
      right: 0;
      background: white;
      padding: 2px;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      display: flex;
      gap: 5px;
    }

    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #3b82f6;
      right: 0;
      bottom: 0;
      cursor: nwse-resize;
    }

    .control-btn {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .control-btn:hover {
      background: #f3f4f6;
    }
  </style>
</head>

<?php include 'includes/navbar.html'; ?>
<nav class="bg-white shadow-md py-4">
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between"
      >
        <div class="flex items-center">
          <a href="/" class="flex items-center">
            <i
              class="fas fa-image text-2xl sm:text-3xl text-blue-800 mr-2 sm:mr-3"
            ></i>
            <span
              class="text-xl sm:text-2xl font-bold text-blue-800 hidden sm:inline"
              >ImgFlow</span
            >
          </a>
        </div>
        <div class="flex items-center">
          <a
            href="/"
            class="bg-blue-600 text-white px-3 py-2 sm:px-4 sm:py-2 rounded-md hover:bg-blue-700 transition-colors duration-200 flex items-center text-sm sm:text-base"
          >
            <i class="fas fa-home mr-1 sm:mr-2"></i> Back to Home
          </a>
        </div>
      </div>
    </nav>
<div class="max-w-6xl mx-auto bg-white rounded-lg shadow-md p-6 mt-10 mb-10">
  <h1 class="text-2xl font-bold text-gray-800 mb-6">Image Overlay Tool</h1>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Left Panel - Controls -->
    <div class="md:col-span-1 bg-gray-50 p-4 rounded-lg">
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Base Image</label>
        <input type="file" id="base-image-input" accept="image/*"
          class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
      </div>

      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Overlay Images</label>
        <input type="file" id="overlay-image-input" accept="image/*" multiple
          class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" />
      </div>

      <button id="download-btn"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition duration-200 mb-4">
        Download Composite
      </button>

      <div class="flex justify-between gap-2">
        <button id="clear-overlays-btn"
          class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-md transition duration-200">
          Clear Overlays
        </button>
        <button id="reset-all-btn"
          class="flex-1 bg-red-100 hover:bg-red-200 text-red-800 py-2 px-4 rounded-md transition duration-200">
          Reset All
        </button>
      </div>
    </div>

    <!-- Right Panel - Canvas -->
    <div class="md:col-span-2">
      <div id="canvas-container"
        class="border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center min-h-64 bg-gray-50">
        <p id="placeholder-text" class="text-gray-500">
          Upload a base image to get started
        </p>
        <img id="base-image" class="hidden" />
      </div>
    </div>
  </div>
</div>
<?php include 'includes/footer.html'; ?>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const baseImageInput = document.getElementById("base-image-input");
    const overlayImageInput = document.getElementById(
      "overlay-image-input"
    );
    const baseImage = document.getElementById("base-image");
    const canvasContainer = document.getElementById("canvas-container");
    const placeholderText = document.getElementById("placeholder-text");
    const downloadBtn = document.getElementById("download-btn");
    const clearOverlaysBtn = document.getElementById("clear-overlays-btn");
    const resetAllBtn = document.getElementById("reset-all-btn");

    let overlays = [];
    let isDragging = false;
    let isResizing = false;
    let currentOverlay = null;
    let offsetX, offsetY;
    let startWidth, startHeight, startX, startY;

    // Load base image
    baseImageInput.addEventListener("change", function (e) {
      if (e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = function (event) {
          baseImage.src = event.target.result;
          baseImage.classList.remove("hidden");
          placeholderText.classList.add("hidden");
          canvasContainer.style.width = "auto";
        };
        reader.readAsDataURL(e.target.files[0]);
      }
    });

    // Add overlay images
    overlayImageInput.addEventListener("change", function (e) {
      if (e.target.files && e.target.files.length > 0) {
        Array.from(e.target.files).forEach((file) => {
          addOverlayImage(file);
        });
      }
    });

    // Add overlay from file
    function addOverlayImage(file) {
      const reader = new FileReader();
      reader.onload = function (event) {
        createOverlayElement(event.target.result);
      };
      reader.readAsDataURL(file);
    }

    // Create overlay element
    function createOverlayElement(src) {
      if (!baseImage.src) {
        alert("Please upload a base image first");
        return;
      }

      const overlay = document.createElement("div");
      overlay.className = "overlay-container";
      overlay.style.position = "absolute";

      const img = document.createElement("img");
      img.src = src;
      img.className = "overlay-image";
      img.style.width = "100px";
      img.style.height = "auto";
      img.draggable = false;

      // Create controls
      const controls = document.createElement("div");
      controls.className = "overlay-controls";
      controls.innerHTML = `
                    <button class="control-btn increase-size" title="Increase size">+</button>
                    <button class="control-btn decrease-size" title="Decrease size">-</button>
                    <button class="control-btn delete-overlay" title="Delete">Ã—</button>
                `;

      // Create resize handle
      const resizeHandle = document.createElement("div");
      resizeHandle.className = "resize-handle";

      overlay.appendChild(img);
      overlay.appendChild(controls);
      overlay.appendChild(resizeHandle);
      canvasContainer.appendChild(overlay);

      // Position randomly on the base image
      const containerRect = canvasContainer.getBoundingClientRect();
      const maxLeft = containerRect.width - 100;
      const maxTop = containerRect.height - 100;

      overlay.style.left = `${Math.random() * maxLeft}px`;
      overlay.style.top = `${Math.random() * maxTop}px`;

      // Add event listeners for dragging
      overlay.addEventListener("mousedown", startDrag);

      // Add event listeners for resize handle
      resizeHandle.addEventListener("mousedown", startResize);

      // Add event listeners for control buttons
      controls
        .querySelector(".increase-size")
        .addEventListener("click", function (e) {
          e.stopPropagation();
          resizeOverlay(overlay, 1.1);
        });

      controls
        .querySelector(".decrease-size")
        .addEventListener("click", function (e) {
          e.stopPropagation();
          resizeOverlay(overlay, 0.9);
        });

      controls
        .querySelector(".delete-overlay")
        .addEventListener("click", function (e) {
          e.stopPropagation();
          overlay.remove();
          overlays = overlays.filter((o) => o !== overlay);
        });

      overlays.push(overlay);
      return overlay;
    }

    // Resize overlay by scale factor
    function resizeOverlay(overlay, scale) {
      const img = overlay.querySelector("img");
      const currentWidth = parseFloat(img.style.width || img.offsetWidth);
      const newWidth = currentWidth * scale;

      if (newWidth > 50 && newWidth < 800) {
        img.style.width = `${newWidth}px`;
        img.style.height = "auto";
      }
    }

    // Drag functionality
    function startDrag(e) {
      if (
        e.target.classList.contains("resize-handle") ||
        e.target.classList.contains("control-btn")
      ) {
        return;
      }

      isDragging = true;
      currentOverlay = this;

      const rect = currentOverlay.getBoundingClientRect();
      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;

      currentOverlay.style.zIndex = 1000;

      document.addEventListener("mousemove", drag);
      document.addEventListener("mouseup", stopDrag);

      e.preventDefault();
    }

    function drag(e) {
      if (!isDragging && !isResizing) return;

      const containerRect = canvasContainer.getBoundingClientRect();

      if (isDragging) {
        let left = e.clientX - offsetX - containerRect.left;
        let top = e.clientY - offsetY - containerRect.top;

        // Boundary checks
        const img = currentOverlay.querySelector("img");
        left = Math.max(
          0,
          Math.min(left, containerRect.width - img.offsetWidth)
        );
        top = Math.max(
          0,
          Math.min(top, containerRect.height - img.offsetHeight)
        );

        currentOverlay.style.left = `${left}px`;
        currentOverlay.style.top = `${top}px`;
      } else if (isResizing) {
        const img = currentOverlay.querySelector("img");
        const newWidth = startWidth + (e.clientX - startX);
        const newHeight = startHeight + (e.clientY - startY);

        if (
          newWidth > 50 &&
          newWidth < 800 &&
          newHeight > 50 &&
          newHeight < 800
        ) {
          img.style.width = `${newWidth}px`;
          img.style.height = `${newHeight}px`;
        }
      }
    }

    function stopDrag() {
      isDragging = false;
      isResizing = false;
      if (currentOverlay) {
        currentOverlay.style.zIndex = "";
      }
      document.removeEventListener("mousemove", drag);
      document.removeEventListener("mouseup", stopDrag);
    }

    function startResize(e) {
      isResizing = true;
      currentOverlay = this.parentElement;
      const img = currentOverlay.querySelector("img");

      startWidth = parseFloat(img.style.width || img.offsetWidth);
      startHeight = parseFloat(img.style.height || img.offsetHeight);
      startX = e.clientX;
      startY = e.clientY;

      currentOverlay.style.zIndex = 1000;

      document.addEventListener("mousemove", drag);
      document.addEventListener("mouseup", stopDrag);

      e.preventDefault();
      e.stopPropagation();
    }

    // Download composite image
    downloadBtn.addEventListener("click", function () {
      if (!baseImage.src) {
        alert("Please upload a base image first");
        return;
      }

      // Create a canvas
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      // Set canvas dimensions to match base image
      canvas.width = baseImage.naturalWidth || baseImage.width;
      canvas.height = baseImage.naturalHeight || baseImage.height;

      // Draw base image
      ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);

      // Draw all overlays
      overlays.forEach((overlay) => {
        if (overlay.parentNode) {
          // Check if overlay still exists in DOM
          const img = overlay.querySelector("img");
          const scaleX = canvas.width / canvasContainer.offsetWidth;
          const scaleY = canvas.height / canvasContainer.offsetHeight;

          const x = parseFloat(overlay.style.left) * scaleX;
          const y = parseFloat(overlay.style.top) * scaleY;
          const width = img.offsetWidth * scaleX;
          const height = img.offsetHeight * scaleY;

          ctx.drawImage(img, x, y, width, height);
        }
      });

      // Create download link
      const link = document.createElement("a");
      link.download = "composite-image.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });

    // Clear all overlays
    clearOverlaysBtn.addEventListener("click", function () {
      document.querySelectorAll(".overlay-container").forEach((overlay) => {
        overlay.remove();
      });
      overlays = [];
    });

    // Reset everything
    resetAllBtn.addEventListener("click", function () {
      baseImage.src = "";
      baseImage.classList.add("hidden");
      placeholderText.classList.remove("hidden");
      baseImageInput.value = "";
      overlayImageInput.value = "";

      document.querySelectorAll(".overlay-container").forEach((overlay) => {
        overlay.remove();
      });
      overlays = [];
    });
  });
</script>
</body>

</html>